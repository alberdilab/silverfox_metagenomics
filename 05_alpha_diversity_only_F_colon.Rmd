# Alpha diversity with colon samples only

```{r load_data_alpha_2, comment="", message=FALSE, warning=FALSE}
load("data/data.Rdata")
```

```{r filter samples_2}
sample_metadata <- sample_metadata %>%
  filter(gut_location == "F_colon")

common_samples <- intersect(sample_metadata$sample, colnames(genome_counts_filt))

sample_metadata <- sample_metadata %>%
  filter(sample %in% common_samples)

genome_counts_filt <- genome_counts_filt %>%
  select(all_of(common_samples), genome)
  
```


## Summary table

```{r alpha_div_2, comment="", message=FALSE, warning=FALSE}
behaviour_colors <- c(
  tame = "#1f77b4",   
  aggr = "#d62728",   
  unsel = "#2ca02c"   
)

# Calculate Hill numbers
richness <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 0) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(richness = 1) %>%
  rownames_to_column(var = "sample")

neutral <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(neutral = 1) %>%
  rownames_to_column(var = "sample")

phylogenetic <- genome_counts_filt %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, tree = genome_tree) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(phylogenetic = 1) %>%
  rownames_to_column(var = "sample")

# # Aggregate basal GIFT into elements
genome_counts_filt <- genome_counts_filt[genome_counts_filt$genome %in% rownames(genome_gifts),]
genome_counts_filt <- genome_counts_filt %>%
  column_to_rownames(., "genome") %>%
  filter(rowSums(. != 0, na.rm = TRUE) > 0) %>%
  select_if(~!all(. == 0))%>%
  rownames_to_column(., "genome")

genome_gifts <- genome_gifts[rownames(genome_gifts) %in% genome_counts_filt$genome,]
genome_gifts <- genome_gifts[, colSums(genome_gifts != 0) > 0]

dist <- genome_gifts %>%
  to.elements(., GIFT_db) %>%
  traits2dist(., method = "gower")

functional <- genome_counts_filt %>%
  filter(genome %in% rownames(dist)) %>%
  column_to_rownames(var = "genome") %>%
  dplyr::select(where(~ !all(. == 0))) %>%
  hilldiv(., q = 1, dist = dist) %>%
  t() %>%
  as.data.frame() %>%
  dplyr::rename(functional = 1) %>%
  rownames_to_column(var = "sample") %>%
  mutate(functional = if_else(is.nan(functional), 1, functional))

# Merge all metrics
alpha_div <- richness %>%
  full_join(neutral, by = join_by(sample == sample)) %>%
  full_join(phylogenetic, by = join_by(sample == sample))%>%
  full_join(functional, by = join_by(sample == sample))
```

```{r alpha_div_fox_behaviours_summary_all_2, comment="",echo=FALSE, message=FALSE, warning=FALSE}
alpha_div %>%
  pivot_longer(-sample, names_to = "alpha", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
    group_by(alpha)%>%
    summarise(
              aggr_mean=mean(value[fox_behaviour=="aggr"], na.rm=T),
              aggr_sd=sd(value[fox_behaviour=="aggr"], na.rm=T),
              tame_mean=mean(value[fox_behaviour=="tame"], na.rm=T),
              tame_sd=sd(value[fox_behaviour=="tame"], na.rm=T),
              unsel_mean=mean(value[fox_behaviour=="unsel"], na.rm=T),
              unsel_sd=sd(value[fox_behaviour=="unsel"], na.rm=T)) %>%
    mutate(
           aggr=str_c(round(aggr_mean,2),"±",round(aggr_sd,2)),
           tame=str_c(round(tame_mean,2),"±",round(tame_sd,2)),
           unsel=str_c(round(unsel_mean,2),"±",round(unsel_sd,2))) %>% 
    arrange(-aggr_mean) %>% 
    dplyr::select(alpha,aggr,tame,unsel) %>% 
    tt()
```

## Aggressive vs Tame

### Shapiro test

```{r alpha_div_shapiro_2, comment="", message=FALSE, warning=FALSE}
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="richness") %>% 
  summarize(shapiro_p_value = shapiro.test(value)$p.value) %>%
  pull(shapiro_p_value)
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="neutral") %>% 
  summarize(shapiro_p_value = shapiro.test(value)$p.value) %>%
  pull(shapiro_p_value)
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="phylogenetic") %>% 
  summarize(shapiro_p_value = shapiro.test(value)$p.value) %>%
  pull(shapiro_p_value)
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="phylogenetic") %>% 
  summarize(var.test_p_value_phylo = var.test(value ~ fox_behaviour)$p.value) 
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="functional") %>% 
  summarize(shapiro_p_value = shapiro.test(value)$p.value) %>%
  pull(shapiro_p_value)
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="unsel") %>% 
  filter(metric=="functional") %>% 
  summarize(var.test_p_functional = var.test(value ~ fox_behaviour)$p.value) 
```

### Plots

```{r alpha_div_boxplot_2, comment="",echo=FALSE, message=FALSE, warning=FALSE}
sample_metadata$fox_behaviour <- factor(sample_metadata$fox_behaviour, levels=c("tame", "unsel", "aggr"))
#Richness
plot1 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="richness") %>%
   filter(!fox_behaviour =="unsel") %>% 
      ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color= fox_behaviour, fill=fox_behaviour)) +
      geom_jitter(width = 0.2, show.legend = FALSE) +
      geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
  scale_x_discrete(labels=c("aggr" = "Aggressive", "tame" = "Tame", "unsel" = "Unselected")) +
    stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(850), label.x = c(1.5))+
coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "Origin", y = "Richness")

#Neutral
plot2 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="neutral") %>%
   filter(!fox_behaviour =="unsel") %>% 
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
  scale_x_discrete(labels=c("aggr" = "Aggressive", "tame" = "Tame",  "unsel" = "Unselected")) +
  stat_compare_means(method = "wilcox.test",show.legend = F, size = 3, label.y = c(150), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  coord_cartesian(ylim = c(0, 150)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "Origin", y = "Neutral")

#Phylogenetic
plot3 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="phylogenetic") %>%
   filter(!fox_behaviour =="unsel") %>% 
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
  scale_x_discrete(labels=c("aggr" = "Aggressive", "tame" = "Tame",  "unsel" = "Unselected")) +
  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(11), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "Origin", y = "Phylogenetic")

#Functional
plot4 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(metric=="functional") %>%
   filter(!fox_behaviour =="unsel") %>% 
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
  scale_x_discrete(labels=c("aggr" = "Aggresive", "tame" = "Tame",  "unsel" = "Unselected")) +
  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "Origin", y = "Functional")

```

```{r div_plot_together_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot1,plot2,plot3, plot4, ncol = 2))
```
```{r div_plot_2_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=8, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot2,plot3))
```





## Tame vs Unselected
```{r alpha_div_fox_behaviours_summary_2, comment="",echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
alpha_div %>%
  pivot_longer(-sample, names_to = "alpha", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
    group_by(alpha)%>%
    summarise(
              tame_mean=mean(value[fox_behaviour=="tame"], na.rm=T),
              tame_sd=sd(value[fox_behaviour=="tame"], na.rm=T),
              unsel_mean=mean(value[fox_behaviour=="unsel"], na.rm=T),
              unsel_sd=sd(value[fox_behaviour=="unsel"], na.rm=T)) %>%
    mutate(
           tame=str_c(round(tame_mean,2),"±",round(tame_sd,2)),
           unsel=str_c(round(unsel_mean,2),"±",round(unsel_sd,2))) %>% 
    arrange(-tame_mean) %>% 
    dplyr::select(alpha,tame,unsel) %>% 
    tt()
```

### Plots
```{r alpha_div_tame_unsel_boxplot_2, comment="",echo=FALSE, message=FALSE, warning=FALSE}
sample_metadata$fox_behaviour <- factor(sample_metadata$fox_behaviour, levels=c("tame", "unsel", "aggr"))
#Richness
plot1 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="aggr") %>%
  filter(metric=="richness") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Richness")

#Neutral
plot2 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="aggr") %>%
  filter(metric=="neutral") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  coord_cartesian(ylim = c(0, 150)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Neutral")

#Phylogenetic
plot3 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="aggr") %>% 
  filter(metric=="phylogenetic") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Phylogenetic")

#Functional
plot4 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="aggr") %>%
  filter(metric=="functional") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Functional")
```
```{r div_plot_tame_unsel_all_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot1,plot2,plot3, plot4, ncol = 2))
```
```{r div_tame_unsel_post2_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=6}
grid.arrange(arrangeGrob(plot2,plot3))
```


## Aggressive vs Unselected

```{r alpha_div_fox_behaviours_aggr_unsel_2, comment="",echo=FALSE, message=FALSE, warning=FALSE, eval=FALSE}
alpha_div %>%
  pivot_longer(-sample, names_to = "alpha", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
    group_by(alpha)%>%
    summarise(
              aggr_mean=mean(value[fox_behaviour=="aggr"], na.rm=T),
              aggr_sd=sd(value[fox_behaviour=="aggr"], na.rm=T),
              unsel_mean=mean(value[fox_behaviour=="unsel"], na.rm=T),
              unsel_sd=sd(value[fox_behaviour=="unsel"], na.rm=T)) %>%
    mutate(
           aggr=str_c(round(aggr_mean,2),"±",round(aggr_sd,2)),
           unsel=str_c(round(unsel_mean,2),"±",round(unsel_sd,2))) %>% 
    arrange(-aggr_mean) %>% 
    dplyr::select(alpha,aggr,unsel) %>% 
    tt()
```

### Plots
```{r alpha_div_aggrvsunsel_boxplot_2, comment="",echo=FALSE, message=FALSE, warning=FALSE}
sample_metadata$fox_behaviour <- factor(sample_metadata$fox_behaviour, levels=c("tame", "unsel", "aggr"))
#Richness
plot1 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="tame") %>%
  filter(metric=="richness") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Richness")

#Neutral
plot2 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="tame") %>%
  filter(metric=="neutral") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  coord_cartesian(ylim = c(0, 150)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Neutral")

#Phylogenetic
plot3 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="tame") %>% 
  filter(metric=="phylogenetic") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "t.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Phylogenetic")

#Functional
plot4 <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == sample)) %>%
  filter(!fox_behaviour =="tame") %>%
  filter(metric=="functional") %>%
  ggplot(aes(y = value, x = fox_behaviour, group=fox_behaviour, color=fox_behaviour, fill=fox_behaviour)) +
  geom_jitter(width = 0.2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha=0.5,outlier.shape = NA, show.legend = FALSE) +
  scale_color_manual(values=behaviour_colors)+
  scale_fill_manual(values=behaviour_colors) +
#  stat_compare_means(method = "wilcox.test", show.legend = F, size = 3, label.y = c(1.6), label.x = c(1.5))+
  coord_cartesian(xlim = c(1, NA)) +
  theme_classic() +
  theme(
    strip.background = element_blank(),
    panel.grid.minor.x = element_line(size = .1, color = "grey"),
    axis.text = element_text(size=10),
    axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0)),
    axis.title.x = element_text(margin = margin(t = 20, r = 0, b = 0, l = 0))
    )+
  labs(x = "fox_behaviour", y = "Functional")
```
```{r div_plot_all_unsel_aggr_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
grid.arrange(arrangeGrob(plot1,plot2,plot3, plot4, ncol = 2))
```

```{r div_plot_2_unsel_aggr_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=6}
grid.arrange(arrangeGrob(plot2,plot3))
```



```{r Testing 3 at once_2}
alpha_long <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample))

# Shapiro–Wilk test (normality per group and metric)
shapiro_results <- alpha_long %>%
  group_by(metric, fox_behaviour) %>%
  filter(n() >= 3) %>%   # Only keep groups with >3 samples
  shapiro_test(value)

# Levene’s test (variance homogeneity across groups, per metric)
levene_results <- alpha_long %>%
  group_by(metric) %>%
  levene_test(value ~ fox_behaviour)

# Kruskal–Wallis test (non-parametric ANOVA alternative, 3+ groups)
kruskal_results <- alpha_long %>%
  group_by(metric) %>%
  kruskal_test(value ~ fox_behaviour)

# Pairwise comparisons (Dunn test with p.adjust)
pairwise_results <- alpha_long %>%
  group_by(metric) %>%
  dunn_test(value ~ fox_behaviour, p.adjust.method = "bonferroni")

# View results
shapiro_results
levene_results
kruskal_results
pairwise_results

```
```{r Plotting all together_2}
# Ensure factor order
alpha_long <- alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(sample_metadata, by = join_by(sample == sample)) %>%
  mutate(fox_behaviour = factor(fox_behaviour, levels = c("tame", "unsel", "aggr")))

# Run Kruskal-Wallis tests per metric
kw_results <- alpha_long %>%
  group_by(metric) %>%
  kruskal_test(value ~ fox_behaviour)

# Build custom facet labels with p-values
facet_labels <- kw_results %>%
  mutate(label = paste0(metric, " (KW p=", signif(p, 3), ")")) %>%
  select(metric, label) %>%
  deframe()

# Plot
plot_all <- alpha_long %>%
  ggplot(aes(x = fox_behaviour, y = value,
             color = fox_behaviour, fill = fox_behaviour)) +
  geom_jitter(width = 0.2, alpha = 0.7, size = 2, show.legend = FALSE) +
  geom_boxplot(width = 0.5, alpha = 0.3, outlier.shape = NA, show.legend = FALSE) +
  facet_wrap(~ metric, scales = "free_y", ncol = 2,
             labeller = labeller(metric = facet_labels)) +
  scale_color_manual(values = behaviour_colors) +
  scale_fill_manual(values = behaviour_colors) +
  theme_classic(base_size = 12) +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold"),
    axis.text = element_text(size = 10),
    axis.title.y = element_text(margin = margin(r = 15)),
    axis.title.x = element_text(margin = margin(t = 15))
  ) +
  labs(x = "Origin", y = "Alpha diversity")

plot_all

```



